# 模拟重力排料算法说明

#### 陈博
#### mddboc@foxmail.com

## 〇、说明
&#8195;&#8195;本算法用到的主要函数在 Connection.h、Connection.cpp中，在Connection.h中对各个函数的功能和参数写了相应的注释。因此本文档的主要作用在于帮助阅读者了解算法的主要的思想（即写这些函数的具体作用是什么），便于维护与进一步优化。

## 一、算法思想
&#8195;&#8195;该算法的整体思想是模拟了真实世界中的自然重力堆积，即：向给定的二维密闭容器中扔圆，直到无法继续为止（给定的二维容器即得到的板料图像，圆即工件）。由于容器可以旋转（可以类比封闭的水杯中装有一定量的水），所以该算法中也需要对图像进行旋转，对不同的旋转角度应用重力算法，找到可以容纳圆最多的位置。


##二、算法中的重点与难点
###1、从哪个位置扔圆的问题
&#8195;&#8195;真实的物理世界中，我们可以想象这样的情景：一个人向空的瓶子中丢小石子，小石子就会自然下落。但是这其实建立在我们已知一个这样的起始位置，该起始位置可以放置一个小石子。那么在给定的板料的图像中，如何用较低的时间复杂度找到一个一定可以放置一个圆的初始位置呢？

###2、怎样模拟下落的问题
&#8195;&#8195;对于有着不规则外壁的容器来说，下落的过程分为几个步骤：垂直下落、沿着底边滚动、受上层物体挤压向某一方向移动。那么应该如何模拟比较复杂下落过程呢？

###3、旋转平移变换引发的坐标转换问题

###4、已经套料计算好的工件位置受上层工件挤压位置改变的问题
&#8195;&#8195;在以前的各种算法中，一旦经过套料计算得到了某一工件的位置后，该工件的位置便不再改变；但是在模拟重力的套料算法中，已经计算好位置的工件要受到后来工件的影响，有可能会改变位置。

###5、上层接口的问题
&#8195;&#8195;本算法的上层接口应该是切割好的各个连通域（包括每个连通域的一张图Array<int> status以及四个边界参数：first-true-h、last-true-h、first-true-w、last-true-w）。由于目前冲床套料系统的切割连通域算法并不完善，导致传递进来的图像与边界参数常常是不吻合的。这需要在套料算法正式进行计算以前，要进行四个边界参数的重新判断。这又进一步引起了时间复杂度的增加。

###6、如何尽可能减小时间复杂度的问题
&#8195;&#8195;通过以上的几个问题可以看出，本算法的算法逻辑比较复杂，完全照搬以前的算法套路会使得时间复杂度到了难以接受的地步，所以要尽可能采取各种办法减小时间复杂度。


##三、算法流程
###1、求取连通域边界参数
&#8195;&#8195;第二部分的问题5已经指出，连通域切割算法传递的结果不是十分可靠，所以要进行边界参数的再判断。具体函数是xxxxxx，方法和之前系统中用的寻找边界参数的方法是一样的，不再赘述。

###2、初始化参数
&#8195;&#8195;比较重要同时看起来比较“奇怪”的参数有以下几个：
####（1）has-calculated-angles:
&#8195;&#8195;旋转一周相当于旋转了360°，has-calculated-angles作为一个vector<int>初始化为360个0，意义是360种度数对应的情况都尚未进行计算。如果某一种情况已经计算过，那么将它对应的度数所在位置置为1，防止重复计算
####（2）candidate-angles：
&#8195;&#8195;算法的目标是选择排料个数最多的一种旋转角度进行坐标变换，但是事实上经常发生的情况是在不同的旋转角度下有着相同的工件数量（例如旋转24°、108°的排料个数均为24个），这时的做法是把这些旋转角度都加入到candidate-angles中，以这些排料相对较多的角度作为“种子”，继续细分步长以寻找下一个可能排料更多的角度（如果角度A比角度B的排料个数更多，那么有理由相信角度A的周围存在排料数更多的角度的__概率__会更大）。
####（3）next-step：
&#8195;&#8195;第二部分的问题6已经指出，我们要尽可能地减小时间复杂度，那么遍历360个角度对应的360种情况显然不是一种时间复杂度低的做法。为了减小时间复杂度，这里采取的办法是__“变步长方法”__。首先将360°分成5份（即步长为72°），计算0°、72°、144°、216°和288°时工件的数量，把排料较多的情况对应的角度放进candidate-angles中；然后以candidate-angles中的角度为__“搜索种子角度”__，步长设为24°继续进行计算（例如上次排料较多的情况是72°和216°，那么这次要计算的角度是48°、96°、192°和240°）；……以此类推。算法中设计的步长是72、24、8、4、2、1（单位：°），根据实际情况选择终止计算步长，一般选择终止计算步长为24°或8°。

###3、设置ROI（Region of Interest）
